
name: Build, Test, and Deploy

on:
  push:
    tags:
      - 'v*'  # Trigger workflow only on version tags (e.g., v1.0.0)
  workflow_dispatch:  # Allows manual triggering

permissions:
  contents: read
  packages: write  # Needed to publish to GitHub Packages

jobs:
  build:
    runs-on: ubuntu-latest

    outputs:
      VERSION: ${{ steps.set_version.outputs.VERSION }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Version from Tag
        id: set_version
        run: |
          VERSION="${GITHUB_REF##*/}"  # Extracts "v1.0.0" from "refs/tags/v1.0.0"
          VERSION="${VERSION#v}"        # Removes leading 'v', resulting in "1.0.0"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn -B package --file pom.xml -Drevision=${{ env.VERSION }}

      - name: Verify JAR File
        run: ls -l target/

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: target/

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Run Tests
        run: mvn test --file pom.xml

  deploy:
    runs-on: ubuntu-latest
    needs: [build, test]
    environment:
      name: 'Production'

    steps:
      - name: SSH Commands to Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          key: ${{ secrets.AZURE_SSH_PRIVATE_KEY }}
          script: |
            cd ~ || exit
            printf "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin || exit
            docker pull ${{ secrets.DOCKER_USERNAME }}/erp:${{ needs.build.outputs.VERSION }} || exit
            docker-compose -f docker-compose.light.yml up -d || exit

  publish-artifact:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts

      - name: Verify JAR File in Target Directory
        run: ls -l target/

      - name: Print VERSION
        run: echo "VERSION is ${{ needs.build.outputs.VERSION }}"

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          server-id: github  # Must match the <id> in your pom.xml's distributionManagement
          server-username: ${{ github.actor }}
          server-password: ${{ secrets.GH_TOKEN }}

      - name: Publish to GitHub Packages
        env:
          VERSION: ${{ needs.build.outputs.VERSION }}
        run: |
          mvn deploy:deploy-file \
            -Dfile=target/AzureTestProject-${VERSION}.jar \
            -DrepositoryId=github \
            -Durl=https://maven.pkg.github.com/charbelba/erp-artifacts \
            -DgroupId=com.example \
            -DartifactId=AzureTestProject \
            -Dversion=${VERSION} \
            -Dpackaging=jar \
            -DgeneratePom=true

